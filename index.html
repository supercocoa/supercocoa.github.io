<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>supercocoa&#39;s blog</title>
  <meta name="author" content="supercocoa">
  
  <meta name="description" content="supercocoa&#39;s blog">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="supercocoa&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/paper.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar  navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">supercocoa&#39;s blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="all the articles.">
			  <i class="fa fa-archive"></i>archives
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="all the tags.">
			  <i class="fa fa-tags"></i>tags
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header ">
  <h1 class="title ">supercocoa&#39;s blog</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      yet another blog.
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
        <!-- render top articles firstly -->
        
		
            
		
            
		
            
		
            
		
            
		
        
        <!-- render other articles -->
        
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> May 21 2016 </div>
			<div class="article-title"><a href="/2016/05/21/lua-c-bridge/" >lua与c相互调用的常用接口</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>lua与c交互主要通过栈，栈底为1，栈顶为-1，以下是其相互调用的常用接口：</p>
<h1 id="c调lua"><a href="#c调lua" class="headerlink" title="c调lua"></a>c调lua</h1><h2 id="栈操作"><a href="#栈操作" class="headerlink" title="栈操作"></a>栈操作</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lua_gettop</span> <span class="params">(lua_State *L)</span></span>;</div><div class="line">返回栈顶元素的索引。 因为索引是从 <span class="number">1</span> 开始编号的， 所以这个结果等于栈上的元素个数； 特别指出，<span class="number">0</span> 表示栈为空。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_settop</span> <span class="params">(lua_State *L, <span class="keyword">int</span> index)</span></span>; <span class="comment">//相当于至栈顶HEAD指针</span></div><div class="line">参数允许传入任何索引以及 <span class="number">0</span> 。 它将把堆栈的栈顶设为这个索引。 如果新的栈顶比原来的大， 超出部分的新元素将被填为 nil 。 如果 index 为 <span class="number">0</span> ， 把栈上所有元素移除。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_pop</span> <span class="params">(lua_State *L, <span class="keyword">int</span> n)</span></span>;</div><div class="line">从栈中弹出 n 个元素。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_insert</span> <span class="params">(lua_State *L, <span class="keyword">int</span> index)</span></span>;</div><div class="line">把栈顶元素移动到指定的有效索引处， 依次移动这个索引之上的元素。 不要用伪索引来调用这个函数， 因为伪索引没有真正指向栈上的位置。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_remove</span> <span class="params">(lua_State *L, <span class="keyword">int</span> index)</span></span>;</div><div class="line">从给定有效索引处移除一个元素， 把这个索引之上的所有元素移下来填补上这个空隙。 不能用伪索引来调用这个函数，因为伪索引并不指向真实的栈上的位置。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_replace</span> <span class="params">(lua_State *L, <span class="keyword">int</span> index)</span></span>;</div><div class="line">把栈顶元素放置到给定位置而不移动其它元素 （因此覆盖了那个位置处的值），然后将栈顶元素弹出。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_pushvalue</span> <span class="params">(lua_State *L, <span class="keyword">int</span> index)</span></span>;</div><div class="line">把栈上给定索引处的元素作一个副本压栈。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_pushboolean</span> <span class="params">(lua_State *L, <span class="keyword">int</span> b)</span></span>;</div><div class="line">把 b 作为一个布尔量压栈。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lua_toboolean</span> <span class="params">(lua_State *L, <span class="keyword">int</span> index)</span></span>;</div><div class="line">把给定索引处的 Lua 值转换为一个 C 中的布尔量（ <span class="number">0</span> 或是 <span class="number">1</span> ）。 和 Lua 中做的所有测试一样， lua_toboolean 会把任何不同于 <span class="literal">false</span> 和 nil 的值当作真返回； 否则就返回假。 （如果你想只接收真正的 boolean 值， 就需要使用 lua_isboolean 来测试值的类型。）</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lua_checkstack</span> <span class="params">(lua_State *L, <span class="keyword">int</span> n)</span></span>;</div><div class="line">确保堆栈上至少有 n 个额外空位。 如果不能把堆栈扩展到相应的尺寸，函数返回假。 失败的原因包括将把栈扩展到比固定最大尺寸还大 （至少是几千个元素）或分配内存失败。 这个函数永远不会缩小堆栈； 如果堆栈已经比需要的大了，那么就保持原样。</div><div class="line"></div><div class="line"><span class="function">lua_Number <span class="title">luaL_checknumber</span> <span class="params">(lua_State *L, <span class="keyword">int</span> arg)</span></span>;</div><div class="line">检查函数的第 arg 个参数是否是一个 数字，并返回这个数字。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lua_getglobal</span> <span class="params">(lua_State *L, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>; <span class="comment">//取全局变量并压栈</span></div><div class="line">把全局变量 name 里的值压栈，返回该值的类型。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_setglobal</span> <span class="params">(lua_State *L, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>; <span class="comment">//设置全局变量并出栈</span></div><div class="line">从堆栈上弹出一个值，并将其设为全局变量 name 的新值。</div></pre></td></tr></table></figure>
<h2 id="table操作："><a href="#table操作：" class="headerlink" title="table操作："></a>table操作：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_createtable</span> <span class="params">(lua_State *L, <span class="keyword">int</span> narr, <span class="keyword">int</span> nrec)</span></span>;</div><div class="line">创建一张新的空表压栈。 参数 narr 建议了这张表作为序列使用时会有多少个元素； 参数 nrec 建议了这张表可能拥有多少序列之外的元素。 Lua 会使用这些建议来预分配这张新表。 如果你知道这张表用途的更多信息，预分配可以提高性能。 否则，你可以使用函数 lua_newtable 。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_newtable</span> <span class="params">(lua_State *L)</span></span>;</div><div class="line">创建一张空表，并将其压栈。 它等价于 lua_createtable(L, <span class="number">0</span>, <span class="number">0</span>) 。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lua_gettable</span> <span class="params">(lua_State *L, <span class="keyword">int</span> index)</span></span>; <span class="comment">//取table里的值，在index处table栈顶k的值</span></div><div class="line">把 t[k] 的值压栈， 这里的 t 是指索引指向的值， 而 k 则是栈顶放的值。</div><div class="line">这个函数会弹出堆栈上的键，把结果放在栈上相同位置。 和在 Lua 中一样， 这个函数可能触发对应 <span class="string">"index"</span> 事件的元方法 （参见 §<span class="number">2.4</span> ）。</div><div class="line">返回压入值的类型。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lua_getfield</span> <span class="params">(lua_State *L, <span class="keyword">int</span> index, <span class="keyword">const</span> <span class="keyword">char</span> *k)</span></span>; <span class="comment">// = lua_pushstring(L, key); lua_gettable(L, -2);</span></div><div class="line">把 t[k] 的值压栈， 这里的 t 是索引指向的值。 在 Lua 中，这个函数可能触发对应 <span class="string">"index"</span> 事件对应的元方法 （参见 §<span class="number">2.4</span> ）。</div><div class="line">函数将返回压入值的类型。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_settable</span> <span class="params">(lua_State *L, <span class="keyword">int</span> index)</span></span>;</div><div class="line">做一个等价于 t[k] = v 的操作， 这里 t 是给出的索引处的值， v 是栈顶的那个值， k 是栈顶之下的值。</div><div class="line">这个函数会将键和值都弹出栈。 跟在 Lua 中一样，这个函数可能触发一个 <span class="string">"newindex"</span> 事件的元方法 （参见 §<span class="number">2.4</span>）。</div><div class="line"></div><div class="line"><span class="keyword">void</span> lua_setfield (lua_State *L, <span class="keyword">int</span> index, <span class="keyword">const</span> <span class="keyword">char</span> *k);</div><div class="line">做一个等价于 t[k] = v 的操作， 这里 t 是给出的索引处的值， 而 v 是栈顶的那个值。</div><div class="line">这个函数将把这个值弹出栈。 跟在 Lua 中一样，这个函数可能触发一个 <span class="string">"newindex"</span> 事件的元方法 （参见 §<span class="number">2.4</span>）。</div><div class="line"></div><div class="line"><span class="keyword">int</span> lua_rawget (lua_State *L, <span class="keyword">int</span> index);</div><div class="line">类似于 lua_gettable ， 但是作一次直接访问（不触发元方法）。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lua_rawgeti</span> <span class="params">(lua_State *L, <span class="keyword">int</span> index, lua_Integer n)</span></span>;</div><div class="line">把 t[n] 的值压栈， 这里的 t 是指给定索引处的表。 这是一次直接访问；就是说，它不会触发元方法。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_rawset</span> <span class="params">(lua_State *L, <span class="keyword">int</span> index)</span></span>;</div><div class="line">类似于 lua_settable ， 但是是做一次直接赋值（不触发元方法）。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_rawseti</span> <span class="params">(lua_State *L, <span class="keyword">int</span> index, lua_Integer i)</span></span>;</div><div class="line">等价于 t[i] = v ， 这里的 t 是指给定索引处的表， 而 v 是栈顶的值。</div><div class="line">这个函数会将值弹出栈。 赋值是直接的；即不会触发元方法。</div><div class="line"></div><div class="line"><span class="keyword">int</span> lua_getmetatable (lua_State *L, <span class="keyword">int</span> index);</div><div class="line">如果该索引处的值有元表，则将其元表压栈，返回 <span class="number">1</span> 。 否则不会将任何东西入栈，返回 <span class="number">0</span> 。</div></pre></td></tr></table></figure>
<h2 id="调lua函数："><a href="#调lua函数：" class="headerlink" title="调lua函数："></a>调lua函数：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lua_pcall</span> <span class="params">(lua_State *L, <span class="keyword">int</span> nargs, <span class="keyword">int</span> nresults, <span class="keyword">int</span> msgh)</span></span>;</div><div class="line">以保护模式调用一个函数。</div><div class="line"></div><div class="line">nargs 和 nresults 的含义与 lua_call 中的相同。 如果在调用过程中没有发生错误， lua_pcall 的行为和 lua_call 完全一致。 但是，如果有错误发生的话， lua_pcall 会捕获它， 然后把唯一的值（错误消息）压栈，然后返回错误码。 同 lua_call 一样， lua_pcall 总是把函数本身和它的参数从栈上移除。</div><div class="line"></div><div class="line">如果 msgh 是 <span class="number">0</span> ， 返回在栈顶的错误消息就和原始错误消息完全一致。 否则， msgh 就被当成是 错误处理函数 在栈上的索引位置。 （在当前的实现里，这个索引不能是伪索引。） 在发生运行时错误时， 这个函数会被调用而参数就是错误消息。 错误处理函数的返回值将被 lua_pcall 作为错误消息返回在堆栈上。</div><div class="line"></div><div class="line">典型的用法中，错误处理函数被用来给错误消息加上更多的调试信息， 比如栈跟踪信息。 这些信息在 lua_pcall 返回后， 由于栈已经展开，所以收集不到了。</div><div class="line"></div><div class="line">lua_pcall 函数会返回下列常数 （定义在 lua.h 内）中的一个：</div><div class="line"></div><div class="line">LUA_OK (<span class="number">0</span>): 成功。</div><div class="line">LUA_ERRRUN: 运行时错误。</div><div class="line">LUA_ERRMEM: 内存分配错误。对于这种错，Lua 不会调用错误处理函数。</div><div class="line">LUA_ERRERR: 在运行错误处理函数时发生的错误。</div><div class="line">LUA_ERRGCMM: 在运行 __gc 元方法时发生的错误。 （这个错误和被调用的函数无关。）</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lua_pcallk</span> <span class="params">(lua_State *L,</span></span></div><div class="line">                <span class="keyword">int</span> nargs,</div><div class="line">                <span class="keyword">int</span> nresults,</div><div class="line">                <span class="keyword">int</span> msgh,</div><div class="line">                lua_KContext ctx,</div><div class="line">                lua_KFunction k);</div><div class="line">这个函数的行为和 lua_pcall 完全一致，只不过它还允许被调用的函数让出</div></pre></td></tr></table></figure>
<h1 id="lua调c"><a href="#lua调c" class="headerlink" title="lua调c"></a>lua调c</h1><h2 id="注册c函数"><a href="#注册c函数" class="headerlink" title="注册c函数"></a>注册c函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*lua_CFunction)</span> <span class="params">(lua_State *L)</span></span>; <span class="comment">//每个函数有自己的局部私有栈</span></div><div class="line">C 函数的类型。</div><div class="line"></div><div class="line">为了正确的和 Lua 通讯， C 函数必须使用下列协议。 这个协议定义了参数以及返回值传递方法： C 函数通过 Lua 中的栈来接受参数， 参数以正序入栈（第一个参数首先入栈）。 因此，当函数开始的时候， lua_gettop(L) 可以返回函数收到的参数个数。 第一个参数（如果有的话）在索引 <span class="number">1</span> 的地方， 而最后一个参数在索引 lua_gettop(L) 处。 当需要向 Lua 返回值的时候， C 函数只需要把它们以正序压到堆栈上（第一个返回值最先压入）， 然后返回这些返回值的个数。 在这些返回值之下的，堆栈上的东西都会被 Lua 丢掉。 和 Lua 函数一样，从 Lua 中调用 C 函数也可以有很多返回值。</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_pushcfunction</span> <span class="params">(lua_State *L, lua_CFunction f)</span></span>; ： <span class="comment">//注册c函数 lua_pushcfunction(L, I_sin); lua_setglobal(L, "mysin");</span></div><div class="line">将一个 C 函数压栈。 这个函数接收一个 C 函数指针， 并将一个类型为 function 的 Lua 值压栈。 当这个栈顶的值被调用时，将触发对应的 C 函数。</div><div class="line">注册到 Lua 中的任何函数都必须遵循正确的协议来接收参数和返回值 （参见 lua_CFunction ）。</div><div class="line">lua_pushcfunction 是作为一个宏定义出现的：</div><div class="line">     <span class="meta">#<span class="meta-keyword">define</span> lua_pushcfunction(L,f)  lua_pushcclosure(L,f,0)</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_register</span> <span class="params">(lua_State *L, <span class="keyword">const</span> <span class="keyword">char</span> *name, lua_CFunction f)</span></span>; <span class="comment">//注册c函数</span></div><div class="line">把 C 函数 f 设到全局变量 name 中。 它通过一个宏定义：</div><div class="line">     <span class="meta">#<span class="meta-keyword">define</span> lua_register(L,n,f) \</span></div><div class="line">            (lua_pushcfunction(L, f), lua_setglobal(L, n))</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> luaL_Reg &#123;</div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *name;</div><div class="line">  lua_CFunction func;</div><div class="line">&#125; luaL_Reg;</div><div class="line">用于 luaL_setfuncs 注册函数的数组类型。 name 指函数名，func 是函数指针。 任何 luaL_Reg 数组必须以一对 name 与 func 皆为 <span class="literal">NULL</span> 结束。</div></pre></td></tr></table></figure>
<h2 id="c模块"><a href="#c模块" class="headerlink" title="c模块"></a>c模块</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//in c</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">I_dir</span> <span class="params">(lua_State *L)</span> </span>&#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct</span> luaL_Reg mylib[] = &#123;</div><div class="line">  &#123;<span class="string">"dir"</span>, I_dir&#125;,</div><div class="line">  &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125; <span class="comment">//结尾</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> luaopen_mylib (lua_State *L) &#123;</div><div class="line">  luaL_register(L, <span class="string">"mylib"</span>, mylib);</div><div class="line">  <span class="keyword">return</span> <span class="number">1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// in lua</span></div><div class="line">require <span class="string">"mylib"</span></div></pre></td></tr></table></figure>
<blockquote>
<p>package.searchers</p>
<p>用于 require 控制如何加载模块的表。</p>
<p>这张表内的每一项都是一个 查找器函数。 当查找一个模块时， require 按次序调用这些查找器， 并传入模块名（require 的参数）作为唯一的一个参数。 此函数可以返回另一个函数（模块的 加载器）加上另一个将传递给这个加载器的参数。 或是返回一个描述为何没有找到这个模块的字符串 （或是返回 nil 什么也不想说）。</p>
<p>Lua 用四个查找器函数初始化这张表。</p>
<p>第一个查找器就是简单的在 package.preload 表中查找加载器。</p>
<p>第二个查找器用于查找 Lua 库的加载库。 它使用储存在 package.path 中的路径来做查找工作。 查找过程和函数 package.searchpath 描述的一致。</p>
<p>第三个查找器用于查找 C 库的加载库。 它使用储存在 package.cpath 中的路径来做查找工作。 同样， 查找过程和函数 package.searchpath 描述的一致。 例如，如果 C 路径是这样一个字符串</p>
<pre><code>&quot;./?.so;./?.dll;/usr/local/?/init.so&quot;
</code></pre><p>查找器查找模块 foo 会依次尝试打开文件 ./foo.so，./foo.dll， 以及 /usr/local/foo/init.so。 一旦它找到一个 C 库， 查找器首先使用动态链接机制连接该库。 然后尝试在该库中找到可以用作加载器的 C 函数。 这个 C 函数的名字是 “luaopen_” 紧接模块名的字符串， 其中字符串中所有的下划线都会被替换成点。 此外，如果模块名中有横线， 横线后面的部分（包括横线）都被去掉。 例如，如果模块名为 a.b.c-v2.1， 函数名就是 luaopen_a_b_c。</p>
<p>第四个搜索器是　一体化加载器。 它从 C 路径中查找指定模块的根名字。 例如，当请求 a.b.c　时， 它将查找 a 这个 C 库。 如果找得到，它会在里面找子模块的加载函数。 在我们的例子中，就是找　luaopen_a_b_c。 利用这个机制，可以把若干 C 子模块打包进单个库。 每个子模块都可以有原本的加载函数名。</p>
<p>除了第一个（预加载）搜索器外，每个搜索器都会返回 它找到的模块的文件名。 这和 package.searchpath 的返回值一样。 第一个搜索器没有返回值。</p>
</blockquote>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://cloudwu.github.io/lua53doc/manual.html" target="_blank" rel="external">http://cloudwu.github.io/lua53doc/manual.html</a></p>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> Jan 3 2016 </div>
			<div class="article-title"><a href="/2016/01/03/golang-list-dir/" >用go写的格式化输出目录文件的小工具</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>这两天用markdown写去年的总结，然后有很多的照片想加进来，发现一个个手写路径比较麻烦，而直接拖进来只有少数编辑器支持，而且一堆图片拖进来的话还是乱序，比较麻烦。</p>
<p>于是用<code>go</code>写了个小程序，可以将目录下的文件按模板输出，还可以选择批量加入指定字符做分隔行。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Usage of listdir:</div><div class="line">  -b string</div><div class="line">    	blank line by</div><div class="line">  -bn int</div><div class="line">    	blank line number</div><div class="line">  <span class="_">-f</span> string</div><div class="line">    	format: xxx___xxx</div><div class="line">  -p string</div><div class="line">    	path (default <span class="string">"./"</span>)</div></pre></td></tr></table></figure></p>
<p>比如我这里就是将目录里的图片全部格式化成markdown的语法，并且每个中间插入3行<code>&lt;br /&gt;</code>做换行，然后输出到s.md中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">listdir <span class="_">-f</span> <span class="string">"\![](___)"</span> -b <span class="string">"&lt;br /&gt;"</span> -bn 3 &gt; s.md</div></pre></td></tr></table></figure></p>
<p>代码如下，也在<a href="https://gist.github.com/supercocoa/10fb7b81ae3853108ec1" target="_blank" rel="external">gist</a>上也放了一份。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"flag"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"io/ioutil"</span></div><div class="line">	<span class="string">"path/filepath"</span></div><div class="line">	<span class="string">"sort"</span></div><div class="line">	<span class="string">"strconv"</span></div><div class="line">	<span class="string">"strings"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	<span class="comment">//PATTERN format by this pattern</span></div><div class="line">	PATTERN = <span class="string">"___"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> path = flag.String(<span class="string">"p"</span>, <span class="string">"./"</span>, <span class="string">"path"</span>)</div><div class="line"><span class="keyword">var</span> format = flag.String(<span class="string">"f"</span>, <span class="string">""</span>, <span class="string">"format: xxx"</span>+PATTERN+<span class="string">"xxx"</span>)</div><div class="line"><span class="keyword">var</span> blankLine = flag.String(<span class="string">"b"</span>, <span class="string">""</span>, <span class="string">"blank line by"</span>)</div><div class="line"><span class="keyword">var</span> blankLineNum = flag.Int(<span class="string">"bn"</span>, <span class="number">0</span>, <span class="string">"blank line number"</span>)</div><div class="line"><span class="keyword">var</span> sortByNum = flag.Bool(<span class="string">"sn"</span>, <span class="literal">true</span>, <span class="string">"sort by num"</span>)</div><div class="line"></div><div class="line"><span class="keyword">type</span> ByNum []<span class="keyword">string</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(paths ByNum)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(paths)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(paths ByNum)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	paths[i], paths[j] = paths[j], paths[i]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(paths ByNum)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	pathi := filepath.Base(paths[i])</div><div class="line">	pathj := filepath.Base(paths[j])</div><div class="line">	namei := strings.Split(pathi, <span class="string">"."</span>)[<span class="number">0</span>]</div><div class="line">	namej := strings.Split(pathj, <span class="string">"."</span>)[<span class="number">0</span>]</div><div class="line">	numi, _ := strconv.Atoi(namei)</div><div class="line">	numj, _ := strconv.Atoi(namej)</div><div class="line">	<span class="keyword">return</span> numi &lt; numj</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">listDir</span><span class="params">(path *<span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</div><div class="line">	files, _ := ioutil.ReadDir(*path)</div><div class="line">	fileSlice := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="built_in">len</span>(files))</div><div class="line"></div><div class="line">	absPath, _ := filepath.Abs(*path)</div><div class="line">	<span class="keyword">for</span> i, file := <span class="keyword">range</span> files &#123;</div><div class="line">		fileSlice[i] = absPath + <span class="string">"/"</span> + file.Name()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> *sortByNum &#123;</div><div class="line">		sort.Sort(ByNum(fileSlice))</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		sort.Strings(fileSlice)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> fileSlice</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">formatStr</span><span class="params">(str *<span class="keyword">string</span>)</span> *<span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(*format) &gt; <span class="number">0</span> &amp;&amp; strings.Contains(*format, PATTERN) &#123;</div><div class="line">		replace := strings.Replace(*format, PATTERN, *str, <span class="number">-1</span>)</div><div class="line">		<span class="keyword">return</span> &amp;replace</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> str</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	flag.Parse()</div><div class="line"></div><div class="line">	rets := listDir(path)</div><div class="line">	<span class="keyword">var</span> ret <span class="keyword">string</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(rets); i++ &#123;</div><div class="line">		ret = rets[i]</div><div class="line">		fmt.Println(*(formatStr(&amp;ret)))</div><div class="line">		<span class="keyword">if</span> i == <span class="built_in">len</span>(rets)<span class="number">-1</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; *blankLineNum; i++ &#123;</div><div class="line">			fmt.Println(*blankLine)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> Oct 24 2015 </div>
			<div class="article-title"><a href="/2015/10/24/shadowsocks-httpproxy/" >通过shadowsocks搭建http代理</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>用shadowsocks科学上网有一阵了，感觉速度很快。这两天在家里用intellij安插件发现很慢，想着能否搭一个本地的http代理中转，将请求发到shadowsocks上，一搜果然有现成的方案，也很简单，这里记录下。</p>
<h3 id="安装Polipo"><a href="#安装Polipo" class="headerlink" title="安装Polipo"></a>安装Polipo</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install polipo</div></pre></td></tr></table></figure>
<h3 id="配置polipo到shadowsocks端口"><a href="#配置polipo到shadowsocks端口" class="headerlink" title="配置polipo到shadowsocks端口"></a>配置polipo到shadowsocks端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service polipo stop</div><div class="line">polipo socksParentProxy=localhost:1080</div></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">各种app里配置http_proxy=localhost:8123</div><div class="line"></div><div class="line">http_proxy=http://localhost:8123 brew update</div><div class="line"></div><div class="line">http_proxy=http://localhost:8123 curl www.google.com</div><div class="line"></div><div class="line">http_proxy=http://localhost:8123 wget www.google.com</div><div class="line"></div><div class="line">git config --global http.proxy 127.0.0.1:8123</div></pre></td></tr></table></figure>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> Sep 26 2015 </div>
			<div class="article-title"><a href="/2015/09/26/react_native_android_js_bridge/" >React Native Android版核心层js-bridge实现浅析</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>这是之前在android版刚出来不久时在内部发的一篇浅析，现在同步上来，这之间，版本由于快速变动或多或少有些许出入，但大体思路暂时未变。</p>
<p>react native的<code>android</code>版于上周发布，然后花了点时间试了下，从几个demo的体验来看都挺流畅，具体环境搭建与基本介绍，可以看看官方的文档说明。<br>之后周末又花了点时间看了下内部的实现，这里主要来简单介绍下java层是如何与js绑定的。</p>
<p>整体架构上，可以分为<code>java层&lt;-&gt;c++层&lt;-&gt;js</code>层，其中java层作为入口，主要是对整体流程的控制，模块的配置。c++层是对JavaScriptCore接口的封装（每个应用自己背一个js解释器），直接执行js脚本并获取返回值。js层则是界面的布局与事件的响应处理。</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight java"><figcaption><span>MoviesActivity.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MoviesActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">DefaultHardwareBackBtnHandler</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> ReactInstanceManager mReactInstanceManager;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">    mReactInstanceManager = ReactInstanceManager.builder()</div><div class="line">        .setApplication(getApplication())</div><div class="line">        .setBundleAssetName(<span class="string">"MoviesApp.android.bundle"</span>)</div><div class="line">        .setJSMainModuleName(<span class="string">"Examples/Movies/MoviesApp.android"</span>)</div><div class="line">        .addPackage(<span class="keyword">new</span> MainReactPackage())</div><div class="line">        .setUseDeveloperSupport(<span class="keyword">true</span>)</div><div class="line">        .setInitialLifecycleState(LifecycleState.RESUMED)</div><div class="line">        .build();</div><div class="line"></div><div class="line">    ((ReactRootView) findViewById(R.id.react_root_view))</div><div class="line">        .startReactApplication(mReactInstanceManager, <span class="string">"MoviesApp"</span>, <span class="keyword">null</span>);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>入口上，主要是在相应使用React的Activity中加入一个ReactRootView，在Activity的onCreate中，通过ReactRootView启动React。这里的<code>addPackage</code>是配置应用所需的java模块与js模块，这个后面会细说。然后React的启动中主要会构造React的context，加载模块配置表，初始化<code>CatalystInstance</code>（java与js调用的高层接口） 与<code>ReactBridge</code>（jni接口封装），最后通过<code>AppRegistry</code>调用到js层的入口完成启动。<br><figure class="highlight java"><figcaption><span>ReactInstanceManager.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attachMeasuredRootViewToInstance</span><span class="params">(</span></span></div><div class="line">    ReactRootView rootView,</div><div class="line">    CatalystInstance catalystInstance) &#123;</div><div class="line">  UiThreadUtil.assertOnUiThread();</div><div class="line"></div><div class="line">  <span class="comment">// Reset view content as it's going to be populated by the application content from JS</span></div><div class="line">  rootView.removeAllViews();</div><div class="line">  rootView.setId(View.NO_ID);</div><div class="line"></div><div class="line">  UIManagerModule uiManagerModule = catalystInstance.getNativeModule(UIManagerModule.class);</div><div class="line">  <span class="keyword">int</span> rootTag = uiManagerModule.addMeasuredRootView(rootView);</div><div class="line">  <span class="meta">@Nullable</span> Bundle launchOptions = rootView.getLaunchOptions();</div><div class="line">  WritableMap initialProps = launchOptions != <span class="keyword">null</span></div><div class="line">      ? Arguments.fromBundle(launchOptions)</div><div class="line">      : Arguments.createMap();</div><div class="line">  String jsAppModuleName = rootView.getJSModuleName();</div><div class="line"></div><div class="line">  WritableNativeMap appParams = <span class="keyword">new</span> WritableNativeMap();</div><div class="line">  appParams.putDouble(<span class="string">"rootTag"</span>, rootTag);</div><div class="line">  appParams.putMap(<span class="string">"initialProps"</span>, initialProps);</div><div class="line">  catalystInstance.getJSModule(AppRegistry.class).runApplication(jsAppModuleName, appParams);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="模块注册"><a href="#模块注册" class="headerlink" title="模块注册"></a>模块注册</h3><p>React Native中，需要用户自己定义需要的配置<code>ReactPackage</code>，显式的声明哪些java类或js脚本是api，是两边都需要的。的然后在启动中注册后，会同时在java端与js端共用一份模块配置表，主要以<code>{moduleID, methodID}</code>定位到某个java模块或js模块的方法。<br><figure class="highlight java"><figcaption><span>CoreModulesPackage.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* package */</span> <span class="class"><span class="keyword">class</span> <span class="title">CoreModulesPackage</span> <span class="keyword">implements</span> <span class="title">ReactPackage</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReactInstanceManager mReactInstanceManager;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DefaultHardwareBackBtnHandler mHardwareBackBtnHandler;</div><div class="line"></div><div class="line">  CoreModulesPackage(</div><div class="line">      ReactInstanceManager reactInstanceManager,</div><div class="line">      DefaultHardwareBackBtnHandler hardwareBackBtnHandler) &#123;</div><div class="line">    mReactInstanceManager = reactInstanceManager;</div><div class="line">    mHardwareBackBtnHandler = hardwareBackBtnHandler;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> List&lt;NativeModule&gt; <span class="title">createNativeModules</span><span class="params">(</span></span></div><div class="line">      ReactApplicationContext catalystApplicationContext) &#123;</div><div class="line">    <span class="keyword">return</span> Arrays.&lt;NativeModule&gt;asList(</div><div class="line">        <span class="keyword">new</span> AnimationsDebugModule(</div><div class="line">            catalystApplicationContext,</div><div class="line">            mReactInstanceManager.getDevSupportManager().getDevSettings()),</div><div class="line">        <span class="keyword">new</span> AndroidInfoModule(),</div><div class="line">        <span class="keyword">new</span> DeviceEventManagerModule(catalystApplicationContext, mHardwareBackBtnHandler),</div><div class="line">        <span class="keyword">new</span> ExceptionsManagerModule(mReactInstanceManager.getDevSupportManager()),</div><div class="line">        <span class="keyword">new</span> Timing(catalystApplicationContext),</div><div class="line">	...</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> List&lt;Class&lt;? extends JavaScriptModule&gt;&gt; createJSModules() &#123;</div><div class="line">    <span class="keyword">return</span> Arrays.asList(</div><div class="line">        DeviceEventManagerModule.RCTDeviceEventEmitter.class,</div><div class="line">        JSTimersExecution.class,</div><div class="line">        RCTEventEmitter.class,</div><div class="line">        AppRegistry.class,</div><div class="line">        ReactNative.class,</div><div class="line">        DebugComponentOwnershipModule.RCTDebugComponentOwnership.class);</div><div class="line">  &#125;</div><div class="line">  ...</div></pre></td></tr></table></figure></p>
<p>模块配置</p>
<figure class="highlight java"><figcaption><span>NativeModuleRegistry.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NativeModuleRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ModuleDefinition&gt; mModuleTable;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;NativeModule&gt;, NativeModule&gt; mModuleInstances;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String mModuleDescriptions;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;OnBatchCompleteListener&gt; mBatchCompleteListenerModules;</div><div class="line">  ...</div></pre></td></tr></table></figure>
<p>java模块注册表</p>
<figure class="highlight java"><figcaption><span>JavaScriptModuleRegistry.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*package*/</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaScriptModuleRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;Class&lt;? extends JavaScriptModule&gt;, JavaScriptModule&gt; mModuleInstances;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>js模块注册表</p>
<figure class="highlight java"><figcaption><span>ToastModule.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToastModule</span> <span class="keyword">extends</span> <span class="title">ReactContextBaseJavaModule</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ToastModule</span><span class="params">(ReactApplicationContext reactContext)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(reactContext);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  <span class="meta">@ReactMethod</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(String message, <span class="keyword">int</span> duration)</span> </span>&#123;</div><div class="line">    Toast.makeText(getReactApplicationContext(), message, duration).show();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>java模块主要是通过<code>@ReactMethod</code>注解表明该方法为可以导出到js的方法</p>
<figure class="highlight java"><figcaption><span>AppRegistry.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * JS module interface - main entry point for launching react application for a given key.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppRegistry</span> <span class="keyword">extends</span> <span class="title">JavaScriptModule</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">runApplication</span><span class="params">(String appKey, WritableMap appParameters)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>JavaScriptModuleRegistry.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaScriptModuleInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CatalystInstance mCatalystInstance;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JavaScriptModuleRegistration mModuleRegistration;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JavaScriptModuleInvocationHandler</span><span class="params">(</span></span></div><div class="line">        CatalystInstance catalystInstance,</div><div class="line">        JavaScriptModuleRegistration moduleRegistration) &#123;</div><div class="line">      mCatalystInstance = catalystInstance;</div><div class="line">      mModuleRegistration = moduleRegistration;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">      String tracingName = mModuleRegistration.getTracingName(method);</div><div class="line">      mCatalystInstance.callFunction(</div><div class="line">          mModuleRegistration.getModuleId(),</div><div class="line">          mModuleRegistration.getMethodId(method),</div><div class="line">          Arguments.fromJavaArgs(args),</div><div class="line">          tracingName);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>js模块是继承JavaScriptModule的interface，与之对应的是在js侧有个同名的js脚本，运行时通过<code>动态代理</code>技术，生成实现，在模块配置表中查找到该js，然后发起调用。</p>
<figure class="highlight java"><figcaption><span>CatalystInstance.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeBridge</span><span class="params">(</span></span></div><div class="line">      JavaScriptExecutor jsExecutor,</div><div class="line">      NativeModuleRegistry registry,</div><div class="line">      JavaScriptModulesConfig jsModulesConfig,</div><div class="line">      JSBundleLoader jsBundleLoader) &#123;</div><div class="line">    mCatalystQueueConfiguration.getJSQueueThread().assertIsOnThread();</div><div class="line">    Assertions.assertCondition(mBridge == <span class="keyword">null</span>, <span class="string">"initializeBridge should be called once"</span>);</div><div class="line">    mBridge = <span class="keyword">new</span> ReactBridge(</div><div class="line">        jsExecutor,</div><div class="line">        <span class="keyword">new</span> NativeModulesReactCallback(),</div><div class="line">        mCatalystQueueConfiguration.getNativeModulesQueueThread());</div><div class="line">    mBridge.setGlobalVariable(</div><div class="line">        <span class="string">"__fbBatchedBridgeConfig"</span>,</div><div class="line">        buildModulesConfigJSONProperty(registry, jsModulesConfig));</div><div class="line">    jsBundleLoader.loadScript(mBridge);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>将模块配置表作为全局变量导入到js层，</p>
<h3 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h3><p>java与js之前的调用，两边都是以<code>{moduleID, methodID}</code>的形式作为一个<code>call</code>，然后一端在之前的模块配置表里查找注册的模块与方法。</p>
<h4 id="java调用js"><a href="#java调用js" class="headerlink" title="java调用js"></a>java调用js</h4><p>是直接通过c++层对JavaScriptCore封装的接口调用到相应的脚本。<br><figure class="highlight java"><figcaption><span>ReactBridge.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">loadScriptFromAssets</span><span class="params">(AssetManager assetManager, String assetName)</span></span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">loadScriptFromNetworkCached</span><span class="params">(String sourceURL, @Nullable String tempFileName)</span></span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">callFunction</span><span class="params">(<span class="keyword">int</span> moduleId, <span class="keyword">int</span> methodId, NativeArray arguments)</span></span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">invokeCallback</span><span class="params">(<span class="keyword">int</span> callbackID, NativeArray arguments)</span></span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">setGlobalVariable</span><span class="params">(String propertyName, String jsonEncodedArgument)</span></span>;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<figure class="highlight c++"><figcaption><span>OnLoad.cpp</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">callFunction</span><span class="params">(JNIEnv* env, jobject obj, jint moduleId, jint methodId,</span></span></div><div class="line">                         NativeArray::jhybridobject args) &#123;</div><div class="line">  <span class="keyword">auto</span> bridge = extractRefPtr&lt;Bridge&gt;(env, obj);</div><div class="line">  <span class="keyword">auto</span> arguments = cthis(wrap_alias(args));</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;folly::dynamic&gt; call&#123;</div><div class="line">    (<span class="keyword">double</span>) moduleId,</div><div class="line">    (<span class="keyword">double</span>) methodId,</div><div class="line">    <span class="built_in">std</span>::move(arguments-&gt;<span class="built_in">array</span>),</div><div class="line">  &#125;;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    bridge-&gt;executeJSCall(<span class="string">"BatchedBridge"</span>, <span class="string">"callFunctionReturnFlushedQueue"</span>, <span class="built_in">std</span>::move(call));</div><div class="line">  &#125; <span class="keyword">catch</span> (...) &#123;</div><div class="line">    translatePendingCppExceptionToJavaException();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>c++层，直接调用<code>BatchedBridge.js</code>即<code>MessageQueue.js</code>中的<code>callFunctionReturnFlushedQueue</code>，最终会加载js对应的模块并调用到相应方法。<br><figure class="highlight js"><figcaption><span>MessageQueue.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">callFunctionReturnFlushedQueue(<span class="built_in">module</span>, method, args) &#123;</div><div class="line">    guard(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.__callFunction(<span class="built_in">module</span>, method, args));</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.flushedQueue();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">__callFunction(<span class="built_in">module</span>, method, args) &#123;</div><div class="line">    BridgeProfiling.profile(<span class="function"><span class="params">()</span> =&gt;</span> <span class="string">`<span class="subst">$&#123;<span class="built_in">module</span>&#125;</span>.<span class="subst">$&#123;method&#125;</span>(<span class="subst">$&#123;stringifySafe(args)&#125;</span>)`</span>);</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">isFinite</span>(<span class="built_in">module</span>)) &#123;</div><div class="line">      method = <span class="keyword">this</span>._methodTable[<span class="built_in">module</span>][method];</div><div class="line">      <span class="built_in">module</span> = <span class="keyword">this</span>._moduleTable[<span class="built_in">module</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; SPY_MODE) &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'N-&gt;JS : '</span> + <span class="built_in">module</span> + <span class="string">'.'</span> + method + <span class="string">'('</span> + <span class="built_in">JSON</span>.stringify(args) + <span class="string">')'</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">module</span> = <span class="keyword">this</span>._require(<span class="built_in">module</span>);</div><div class="line">    <span class="built_in">module</span>[method].apply(<span class="built_in">module</span>, args);</div><div class="line">    BridgeProfiling.profileEnd();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h4 id="js调用java"><a href="#js调用java" class="headerlink" title="js调用java"></a>js调用java</h4><p>React Native的设计是js<code>不会</code>直接调用java，而是将调用的call插入到一个js层的一个<code>MessageQueue</code>中，<code>等</code>java过来调用。<br><figure class="highlight js"><figcaption><span>MessageQueue.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageQueue</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">constructor</span>(remoteModules, localModules, customRequire) &#123;</div><div class="line">    <span class="keyword">this</span>.RemoteModules = &#123;&#125;;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>._require = customRequire || <span class="built_in">require</span>;</div><div class="line">    <span class="keyword">this</span>._queue = [[],[],[]];</div><div class="line">    <span class="keyword">this</span>._moduleTable = &#123;&#125;;</div><div class="line">    <span class="keyword">this</span>._methodTable = &#123;&#125;;</div><div class="line">    <span class="keyword">this</span>._callbacks = [];</div><div class="line">    <span class="keyword">this</span>._callbackID = <span class="number">0</span>;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<figure class="highlight js"><figcaption><span>MessageQueue.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">__nativeCall(<span class="built_in">module</span>, method, params, onFail, onSucc) &#123;</div><div class="line">    <span class="keyword">if</span> (onFail || onSucc) &#123;</div><div class="line">      <span class="comment">// eventually delete old debug info</span></div><div class="line">      (<span class="keyword">this</span>._callbackID &gt; (<span class="number">1</span> &lt;&lt; <span class="number">5</span>)) &amp;&amp;</div><div class="line">        (<span class="keyword">this</span>._debugInfo[<span class="keyword">this</span>._callbackID &gt;&gt; <span class="number">5</span>] = <span class="literal">null</span>);</div><div class="line"></div><div class="line">      <span class="keyword">this</span>._debugInfo[<span class="keyword">this</span>._callbackID &gt;&gt; <span class="number">1</span>] = [<span class="built_in">module</span>, method];</div><div class="line">      onFail &amp;&amp; params.push(<span class="keyword">this</span>._callbackID);</div><div class="line">      <span class="keyword">this</span>._callbacks[<span class="keyword">this</span>._callbackID++] = onFail;</div><div class="line">      onSucc &amp;&amp; params.push(<span class="keyword">this</span>._callbackID);</div><div class="line">      <span class="keyword">this</span>._callbacks[<span class="keyword">this</span>._callbackID++] = onSucc;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>._queue[MODULE_IDS].push(<span class="built_in">module</span>);</div><div class="line">    <span class="keyword">this</span>._queue[METHOD_IDS].push(method);</div><div class="line">    <span class="keyword">this</span>._queue[PARAMS].push(params);</div><div class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; SPY_MODE &amp;&amp; <span class="built_in">isFinite</span>(<span class="built_in">module</span>)) &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'JS-&gt;N : '</span> + <span class="keyword">this</span>._remoteModuleTable[<span class="built_in">module</span>] + <span class="string">'.'</span> +</div><div class="line">        <span class="keyword">this</span>._remoteMethodTable[<span class="built_in">module</span>][method] + <span class="string">'('</span> + <span class="built_in">JSON</span>.stringify(params) + <span class="string">')'</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>具体是在java层主动调用或各种事件到来时（触摸，刷新，timer…），都会调用上文说的java层的callFunction，从而最终调用上文说到的<code>callFunctionReturnFlushedQueue</code>，注意该方法会在执行相应js调用后调用<code>flushedQueue</code>并返回MessageQueue.<br><figure class="highlight js"><figcaption><span>MessageQueue.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">flushedQueue() &#123;</div><div class="line">    BridgeProfiling.profile(<span class="string">'JSTimersExecution.callImmediates()'</span>);</div><div class="line">    guard(<span class="function"><span class="params">()</span> =&gt;</span> JSTimersExecution.callImmediates());</div><div class="line">    BridgeProfiling.profileEnd();</div><div class="line">    <span class="keyword">let</span> queue = <span class="keyword">this</span>._queue;</div><div class="line">    <span class="keyword">this</span>._queue = [[],[],[]];</div><div class="line">    <span class="keyword">return</span> queue[<span class="number">0</span>].length ? queue : <span class="literal">null</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>返回的queue格式化为json经由c++返回给java<br><figure class="highlight c++"><figcaption><span>Bridge.cpp</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">executeJSCall</span><span class="params">(</span></span></div><div class="line">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; moduleName,</div><div class="line">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; methodName,</div><div class="line">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;folly::dynamic&gt;&amp; arguments) &#123;</div><div class="line">    <span class="keyword">auto</span> returnedJSON = m_jsExecutor-&gt;executeJSCall(moduleName, methodName, arguments);</div><div class="line">    m_callback(parseMethodCalls(returnedJSON));</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight c++"><figcaption><span>OnLoad.cpp</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(JNIEnv* env, jobject obj, jobject executor, jobject callback,</span></span></div><div class="line">                   jobject callbackQueueThread) &#123;</div><div class="line">  <span class="keyword">auto</span> weakCallback = createNew&lt;WeakReference&gt;(callback);</div><div class="line">  <span class="keyword">auto</span> weakCallbackQueueThread = createNew&lt;WeakReference&gt;(callbackQueueThread);</div><div class="line">  <span class="keyword">auto</span> bridgeCallback = [weakCallback, weakCallbackQueueThread] (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;MethodCall&gt; calls) &#123;</div><div class="line">    dispatchCallbacksToJava(weakCallback, weakCallbackQueueThread, <span class="built_in">std</span>::move(calls));</div><div class="line">  &#125;;</div><div class="line">  <span class="keyword">auto</span> nativeExecutorFactory = extractRefPtr&lt;JSExecutorFactory&gt;(env, executor);</div><div class="line">  <span class="keyword">auto</span> bridge = createNew&lt;Bridge&gt;(nativeExecutorFactory, bridgeCallback);</div><div class="line">  setCountableForJava(env, obj, <span class="built_in">std</span>::move(bridge));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>CatalysInstance.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">NativeModulesReactCallback</span> <span class="keyword">implements</span> <span class="title">ReactCallback</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">int</span> moduleId, <span class="keyword">int</span> methodId, ReadableNativeArray parameters)</span> </span>&#123;</div><div class="line">      mCatalystQueueConfiguration.getNativeModulesQueueThread().assertIsOnThread();</div><div class="line"></div><div class="line">      <span class="comment">// Suppress any callbacks if destroyed - will only lead to sadness.</span></div><div class="line">      <span class="keyword">if</span> (mDestroyed) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      mJavaRegistry.call(CatalystInstance.<span class="keyword">this</span>, moduleId, methodId, parameters);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>最终java层依旧是查表调用对应的方法。</p>
<h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p>线程方面 主要分为了三种线程</p>
<ul>
<li><code>UIQueueThread</code>   android本身的ui线程，最终绘制肯定还得在这里</li>
<li><code>NativeModulesQueueThread</code>   js调过来的native module的方法执行的线程</li>
<li><code>JSQueueThread</code>   js解释器线程 <figure class="highlight java"><figcaption><span>CatalystQueueConfiguration.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Specifies which &#123;<span class="doctag">@link</span> MessageQueueThread&#125;s must be used to run the various contexts of</div><div class="line"> * execution within catalyst (Main UI thread, native modules, and JS). Some of these queues *may* be</div><div class="line"> * the same but should be coded against as if they are different.</div><div class="line"> *</div><div class="line"> * UI Queue Thread: The standard Android main UI thread and Looper. Not configurable.</div><div class="line"> * Native Modules Queue Thread: The thread and Looper that native modules are invoked on.</div><div class="line"> * JS Queue Thread: The thread and Looper that JS is executed on.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatalystQueueConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> MessageQueueThread mUIQueueThread;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> MessageQueueThread mNativeModulesQueueThread;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> MessageQueueThread mJSQueueThread;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>以上就是React Native Android版java和js间相互调用的主要实现，从demo的体验感觉整体上比较流畅，起码简单的页面感知上和native区分不太开。而且只要reload一遍js bundle，不用重启不用切换，页面立即原地更新，这个应该是一个很大的卖点。</p>
<p>代码上整体分层挺清晰，集合了包括fresco/okhttp/botls/boost/folly等不少开源库，java层用了动态代理，c++层的代码是用c++11封装的，js中也是使用了不少es6的新特性，还有jsx，css layout什么的，模式上也是状态驱动UI，整体实现感觉很是前卫，但是要完全掌握可能要java/c++/js三修，对现有的开发模式是一个新的挑战。而且由于依赖库太多，导致安装包略肿大，光so就有4.5MB，这给集成到现有项目带来了不少问题。</p>
<p>另外，由于监听了<code>Choreographer</code>的事件，使用了些高版本的api，导致<code>4.1</code>以下不能使用React。</p>
<p>而且实际使用中，由于react本身其实主要还是帮助做绑定，导致稍微复杂一点的界面和逻辑，还是少不了native的大量参与，除非导出的组件已经足够用或者界面足够简单。</p>
<p>总的来说，虽然可能刚出来还存在不少问题，包大小与开发方式也需要进一步的探索，但react native的整体设计与实现还是很值得学习的，或许今后会带来app开发新的思路吧。</p>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> Feb 8 2015 </div>
			<div class="article-title"><a href="/2015/02/08/mac_update_mem/" >记macbook扩展到16g内存</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>我的macbook小白是2010款，macbook最后一代，已经用了4年。中间想过卖掉换成pro，可一看pro的价钱，我又不想再买个13寸的，再加上这个绝版的还算漂亮的小白，就决定先扩展硬件再撑几年，等mac os不支持这款了再说。  期间更新过两次内存，先开始只有2g，升到了4g，后来又买了单根8g的，扩展到了10g。最近又觉得不够用，于是把又升了下级。</p>
<h2 id="ssd"><a href="#ssd" class="headerlink" title="ssd"></a>ssd</h2><p>在升级内存前，先是看到说更换为ssd的提升比最大，可我又觉得128g的ssd太小，而且也不想倒腾原来的数据，最后发现可以把光驱拆下来，然后买个光驱托盘，把ssd嵌到里面，放到拆下来的光驱位置上。这样下来，反正现在光驱也没用，多了一个ssd，把系统安到ssd上，从ssd启动，开机速度飞快，再把各种软件和常用的文档也放到ssd下，之前的老爷机仿佛获得新生。</p>
<p>更换ssd这里，没什么好说的，都是物理上的拆机更换零件。有一点需要注意，拆机的工具最好直接从淘宝上购买麦哲伦mac拆机工具套装，免得为找各种型号的螺丝刀折腾。</p>
<h2 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h2><p>在更换了ssd后，其实整体感觉已经十分流畅了，但看着系统信息里的2+8，感觉十分的不对称，再加上开个ide chrome等内存杀手，内存使用一下飙到9g+，还是决定再来根8g的。</p>
<p>不换还好，一换才发现有坑。</p>
<p>我的macbook型号太老，只支持1067MHz频率ddr3的内存条，可现在市面上卖的单根8g都是1600的，拿过来插上两根1600的一开机就滴滴响，无法启动。之前的2+8没有问题，是因为8g的1600在2g的1067下会自动降频到1067。</p>
<p>这下就要开始折腾了，网上google了一下，好在之前有强人遇到过这种问题（<a href="http://bbs.feng.com/read-htm-tid-2367368.html" target="_blank" rel="external">简单的修改让你1333的内存完美使用在374上</a>），办法是在win下(非虚拟机)利用软件将8g的那根内存条的spd信息改成1067，这样再来一根1600的就会自动降频到1067，也就可以和谐共处了。</p>
<p>好，看上去也不算麻烦，就是安个win7用软件改下内存么，结果蛋疼的事情又来了…</p>
<h2 id="win7"><a href="#win7" class="headerlink" title="win7"></a>win7</h2><p>之前把光驱换成了ssd，于是就想那就usb安个win7就行，可usb查到mac上，用bootcamp打开发现我这款老爷机无法用usb安win wtf.. 好在网上找到文章说可以改bootcamp pkg下的信息来绕过去（<a href="http://forums.macrumors.com/showthread.php?t=1680652" target="_blank" rel="external">How to Enable USB Install on Mavericks for unSupported Bootcamps</a>），但实际试了下发现还是不行，开机会找不到u盘。</p>
<p>于是又反复google，找到了<a href="http://refit.sourceforge.net/" target="_blank" rel="external">refit</a>，这个扩展工具可以让mac在开机后自由选择启动盘，比系统本身的开机option要好用，有点像ubuntu的启动引导。</p>
<p>但杯具的是，这次是找到了U盘，但按下从u盘启动安装又报了个什么错误，还是不行 (但rEFIt本身不错 留着以后可以很方便的在多系统间切换)。</p>
<p>最后，反复google后(我的google能力还是不错的 经得起折腾…) 找到了可以通过虚拟机安装win7后直接copy到bootcamp的方法曲线救国（<a href="http://forums.macrumors.com/showthread.php?p=20584499#post20584499" target="_blank" rel="external">Install a Windows 7 partition on Mac OSX without Optical Drive or USB</a>）， 终于安上了win7…</p>
<h2 id="改内存spd"><a href="#改内存spd" class="headerlink" title="改内存spd"></a>改内存spd</h2><p>有了win7后，就可以通过之前提到过的方法，用Thaiphoon这个工具修改8g内存条的spd即可，然后换下2g的，换上扩展的8g的，大功告成！</p>
<h2 id="还有"><a href="#还有" class="headerlink" title="还有"></a>还有</h2><p>上面提到的步骤里需要几个工具，找这些工具的破解版又是一顿折腾，这里就不细说了。</p>
<p>parallels / vmware-fusion  // 虚拟机 用于安装win7<br>vmdk mounter // 将虚拟机安装文盘挂载到mac上<br>winclone // 将挂载后的虚拟盘里的安装文件copy到bootcamp盘上 完成安装<br>thaiphoon // win下修改内存spd信息</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>经过一番折腾(不想再来一次了)，总算是扩展到了16g内存，顺利开机，顿时有种驾驶ae86的感觉 ^_^</p>
<p>成果图:</p>
<p><img src="/img/mac_update_mem/mac_update_mem_1.png" alt=""></p>

	
	</div>
</div>

           
		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/android/">android<span>1</span></a></li>
		
			<li><a href="/categories/golang/">golang<span>1</span></a></li>
		
			<li><a href="/categories/lua/">lua<span>1</span></a></li>
		
			<li><a href="/categories/mac/">mac<span>1</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/markdown/">markdown<span>1</span></a></li>
		
			<li><a href="/tags/golang/">golang<span>1</span></a></li>
		
			<li><a href="/tags/c/">c<span>1</span></a></li>
		
			<li><a href="/tags/react-native/">react-native<span>1</span></a></li>
		
			<li><a href="/tags/shadowsocks/">shadowsocks<span>1</span></a></li>
		
			<li><a href="/tags/android/">android<span>1</span></a></li>
		
			<li><a href="/tags/lua/">lua<span>1</span></a></li>
		
			<li><a href="/tags/mac/">mac<span>1</span></a></li>
		
			<li><a href="/tags/http-proxy/">http_proxy<span>1</span></a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2016/05/21/lua-c-bridge/" ><i class="fa fa-file-o"></i>lua与c相互调用的常用接口</a>
      </li>
    
      <li>
        <a href="/2016/01/03/golang-list-dir/" ><i class="fa fa-file-o"></i>用go写的格式化输出目录文件的小工具</a>
      </li>
    
      <li>
        <a href="/2015/10/24/shadowsocks-httpproxy/" ><i class="fa fa-file-o"></i>通过shadowsocks搭建http代理</a>
      </li>
    
      <li>
        <a href="/2015/09/26/react_native_android_js_bridge/" ><i class="fa fa-file-o"></i>React Native Android版核心层js-...</a>
      </li>
    
      <li>
        <a href="/2015/02/08/mac_update_mem/" ><i class="fa fa-file-o"></i>记macbook扩展到16g内存</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/supercocoa" title="my github account." target="_blank"]);">Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->


	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2017 supercocoa
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
